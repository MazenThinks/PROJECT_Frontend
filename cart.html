<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="styling.css" />
    <link rel="stylesheet" href="cart.css" />
    <link rel="icon" type="image/x-icon" href="Assets/Box-seam.png" />
    <title>Cart</title>
  </head>
  <body>
    <!-- Navbar -->
    <header class="py-3 mb-0 border-bottom">
      <div class="container d-flex flex-wrap justify-content-center">
        <a
          href="/"
          class="d-flex align-items-center mb-3 mb-lg-0 me-lg-auto link-body-emphasis text-decoration-none titleanimation"
        >
          <img src="logoo/logo1.png" alt="logo" width="50px" height="40px" />
          <span class="fs-4 me-1 title">PickPay</span>
        </a>
        <form class="d-flex searchmarg" role="search">
          <input
            class="form-control me-2 col-12 navsearch"
            type="search"
            placeholder="What are you looking for?"
            aria-label="Search"
          />
        </form>
        <div class="cart text-decoration-none me-3">
          <a
            href="cart.html"
            class="d-flex align-items-center mb-3 mb-lg-0 me-lg-auto link-body-emphasis text-decoration-none cartanim"
          >
            <img
              src="Assets/cart.svg"
              width="23"
              height="23"
              fill="currentColor"
              class="bi bi-box-seam me-1"
              viewBox="0 0 16 16"
            />
            <path
              d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2zm3.564 1.426L5.596 5 8 5.961 14.154 3.5zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464z"
            />
            <span class="cartext">Cart</span>
          </a>
        </div>
        <div class="text-end">
          <a href="signinPage.html"
            ><button type="button" class="btn btn-light text-dark me-2 ms-4">
              Login
            </button></a
          >
          <a href="signupPage.html"
            ><button type="button" class="btn btn-primary">Sign Up</button></a
          >
        </div>
      </div>
    </header>
    <nav
      class="navbar navbar-expand-lg bg-body-tertiary d-flex justify-content-center"
    >
      <div class="container-fluid d-flex flex-wrap justify-content-center">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse d-flex justify-content-center"
          id="navbarNav"
        >
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="index.html">All</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="elecCat.html">Electronics</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="ApplianCat.html">Appliances</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="HomeCat.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="videogamecat.html">Video Games</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="Fashion.html">Fashion</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="Beauty.html">Beauty & Fragrance</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">
        <div class="col-8 mt-2" id="cart-items">
          <div>
            <div class="row">
              <div class="col">
                <img
                  src="Assets/cart/empty.svg"
                  alt="empty cart"
                  class="emptyphoto"
                />
              </div>
              <div class="col">
                <h2 class="emptytext">Your cart is currently empty</h2>
                <p><a href="index.html">Shop Today's deals</a></p>
                <button type="button" class="btn btn-outline-primary signinbtn">
                  Sign in to your account
                </button>
                <br />
                <button type="button" class="btn btn-success signupbtn">
                  Create an account
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-3 side align-middle mb-4">
          <div>
            <div>
              <h3 class="mt-3 align-middle">
                Customers Who Bought Items in Your Recent History Also Bought
              </h3>
            </div>
            <!-- Product 1 -->
            <div>
              <a href="#" class="cardlinking">
                <div class="Product d-flex flex-column blacking">
                  <div class="py-3 alignment">
                    <img
                      src="Assets/Photoshop/Elec3.png"
                      alt="Product1"
                      height="200px"
                    />
                  </div>
                  <div class="align-items-start productxt p-2">
                    <p class="slicingText">
                      Samsung 55 Inch QLED Smart TV Neural HDR Quantum Processor
                      Lite 4K - QA55QE1DAUXEG [2024 Model]
                    </p>
                    <p>
                      <span class="curr">EGP</span
                      ><span class="price"> 6,580</span> &nbsp;&nbsp;<s
                        class="oldprice"
                        >80,000</s
                      >
                      <span class="discountpercentage">25%</span>
                    </p>
                    <p>
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <span class="stars">(88)</span>
                    </p>
                  </div>
                </div>
              </a>
            </div>
            <!-- Product 2 -->
            <div class="mt-2">
              <a href="#" class="cardlinking">
                <div class="Product d-flex flex-column blacking">
                  <div class="py-3 alignment">
                    <img
                      src="Assets/Photoshop/Elec3.png"
                      alt="Product1"
                      height="200px"
                    />
                  </div>
                  <div class="align-items-start productxt p-2">
                    <p class="slicingText">
                      Samsung 55 Inch QLED Smart TV Neural HDR Quantum Processor
                      Lite 4K - QA55QE1DAUXEG [2024 Model]
                    </p>
                    <p>
                      <span class="curr">EGP</span
                      ><span class="price"> 6,580</span> &nbsp;&nbsp;<s
                        class="oldprice"
                        >80,000</s
                      >
                      <span class="discountpercentage">25%</span>
                    </p>
                    <p>
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <span class="stars">(88)</span>
                    </p>
                  </div>
                </div>
              </a>
            </div>
            <!-- Product 3 -->
            <div class="mt-2">
              <a href="#" class="cardlinking">
                <div class="Product d-flex flex-column blacking">
                  <div class="py-3 alignment">
                    <img
                      src="Assets/Photoshop/Elec3.png"
                      alt="Product1"
                      height="200px"
                    />
                  </div>
                  <div class="align-items-start productxt p-2">
                    <p class="slicingText">
                      Samsung 55 Inch QLED Smart TV Neural HDR Quantum Processor
                      Lite 4K - QA55QE1DAUXEG [2024 Model]
                    </p>
                    <p>
                      <span class="curr">EGP</span
                      ><span class="price"> 6,580</span> &nbsp;&nbsp;<s
                        class="oldprice"
                        >80,000</s
                      >
                      <span class="discountpercentage">25%</span>
                    </p>
                    <p>
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <img
                        src="Assets/star.png"
                        alt="star"
                        height="20px"
                        width="20px"
                      />
                      <span class="stars">(88)</span>
                    </p>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="px-5 text-center bg-body-tertiary">
      <footer class="py-4">
        <div class="row">
          <div class="col-6 col-md-2 mb-3">
            <h5>Electronics</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Mobile & Tablets</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary">TVs</a>
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary">Laptop</a>
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Audio Devices</a
                >
              </li>
            </ul>
          </div>

          <div class="col-6 col-md-2 mb-3">
            <h5>Appliances</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Large Appliances</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Small Appliances</a
                >
              </li>
            </ul>
          </div>

          <div class="col-6 col-md-2 mb-3">
            <h5>Home</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Furniture</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Home Decor</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Kitchen & Dining</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Bath & Bedding</a
                >
              </li>
            </ul>
          </div>

          <div class="col-6 col-md-2 mb-3">
            <h5>Video Games</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary">Console</a>
              </li>

              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Controllers</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Accessories</a
                >
              </li>
            </ul>
          </div>

          <div class="col-6 col-md-2 mb-3">
            <h5>Fashion</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Women's Fashion</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Men's Fashion</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Kids' Fashion</a
                >
              </li>
            </ul>
          </div>

          <div class="col-6 col-md-2 mb-3">
            <h5>Beauty & Fragrance</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary">Makeup</a>
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Skincare</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Haircare</a
                >
              </li>
              <li class="nav-item mb-2">
                <a href="#" class="nav-link p-0 text-body-secondary"
                  >Fragrance</a
                >
              </li>
            </ul>
          </div>
        </div>

        <div class="py-5 border-top">
          <p>© 2025 PickPay, Inc. All rights reserved.</p>
        </div>
      </footer>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="cart.js"></script>
    <script src="script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        const cartContainer = document.getElementById("cart-items");
        const emptyCartSection = `<div class='text-center my-5'><img src='Assets/cart/empty.svg' alt='empty cart' class='emptyphoto'/><h2 class='emptytext'>Your cart is currently empty</h2><p><a href='index.html'>Shop Today's deals</a></p><button type='button' class='btn btn-outline-primary signinbtn'>Sign in to your account</button><br/><button type='button' class='btn btn-success signupbtn'>Create an account</button></div>`;

        // Helper to render cart items
        function renderCartItems(items, userName) {
          if (!items || items.length === 0) {
            cartContainer.innerHTML = emptyCartSection;
            return;
          }
          let html = `<h2 class="mb-4">Your Cart</h2>`;
          if (userName) {
            html += `<h5 class="mb-3">User: <span class="text-primary">${userName}</span></h5>`;
          }
          html += '<ul class="list-group mb-3">';
          let total = 0;
          items.forEach((item) => {
            // Always display product name and image
            let name = "";
            if (item.product && item.product.name) {
              name = item.product.name;
            } else if (item.name) {
              name = item.name;
            } else if (item.product && item.product.title) {
              name = item.product.title;
            } else {
              name = "Product";
            }
            // Slice name to 90 characters
            if (name.length > 90) {
              name = name.slice(0, 90) + "...";
            }
            // Try to get product image
            let image = "";
            if (item.product && item.product.image) {
              image = item.product.image;
            } else if (
              item.product &&
              item.product.images &&
              item.product.images.length > 0
            ) {
              image = item.product.images[0];
            } else {
              image = "Assets/Box-seam.png"; // fallback image
            }
            const price =
              item.product && item.product.price
                ? item.product.price
                : item.price || 0;
            const quantity = item.quantity || 1;
            let priceDisplay = "";
            if (quantity > 1) {
              priceDisplay = `${quantity} x EGP ${price}<br>= EGP ${
                price * quantity
              }`;
            } else {
              priceDisplay = `EGP ${price}`;
            }
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <img src="${image}" alt="product" style="width:48px;height:48px;object-fit:cover;border-radius:8px;margin-right:12px;">
                <div>
                  <strong>${name}</strong><br>
                  <span>Qty: 
                    <button class="btn btn-light btn-sm px-2 py-0 quantity-decrease" data-id="${
                      item._id
                    }" style="font-size:1.2rem;">−</button>
                    <span class="mx-2" id="qty-${item._id}">${quantity}</span>
                    <button class="btn btn-light btn-sm px-2 py-0 quantity-increase" data-id="${
                      item._id
                    }" style="font-size:1.2rem;">+</button>
                  </span>
                  ${
                    item.color
                      ? `<span class='ms-2'>Color: ${item.color}</span>`
                      : ""
                  }
                </div>
              </div>
              <div>
                <span class="me-3">${priceDisplay}</span>
                <button class="btn btn-danger btn-sm remove-item-btn" data-id="${
                  item._id
                }">Remove</button>
              </div>
            </li>`;
            total += price * quantity;
          });
          html += "</ul>";
          html += `<div class="mb-3"><strong>Total: EGP ${total}</strong></div>`;
          html += '<div class="d-flex justify-content-between mb-4">';
          html +=
            '<div><button class="btn btn-warning py-2 px-4" id="clearCartBtn" style="font-size: 0.95rem; border-radius: 18px; font-weight: 500; max-width: 140px;">Clear Cart</button></div>';
          html +=
            '<div><button class="btn btn-success py-2 px-4" id="checkoutBtn" style="font-size: 0.95rem; border-radius: 18px; font-weight: 500; max-width: 140px;">Checkout</button></div>';
          html += "</div>";
          cartContainer.innerHTML = html;

          // Remove item event
          document.querySelectorAll(".remove-item-btn").forEach((btn) => {
            btn.addEventListener("click", async function () {
              await document.removeFromCart(this.dataset.id);
              location.reload();
            });
          });
          // Clear cart event
          document
            .getElementById("clearCartBtn")
            .addEventListener("click", async function () {
              await document.clearCart();
              location.reload();
            });
          // Checkout event
          document
            .getElementById("checkoutBtn")
            .addEventListener("click", function () {
              window.location.href = "checkout.html";
            });

          // Quantity increase/decrease events
          document.querySelectorAll(".quantity-increase").forEach((btn) => {
            btn.addEventListener("click", async function () {
              const id = this.dataset.id;
              const qtySpan = document.getElementById(`qty-${id}`);
              let currentQty = parseInt(qtySpan.textContent);
              const resp = await document.updateCartItemQuantity(
                id,
                currentQty + 1
              );
              console.log("Increase resp:", resp);
              location.reload();
            });
          });
          document.querySelectorAll(".quantity-decrease").forEach((btn) => {
            btn.addEventListener("click", async function () {
              const id = this.dataset.id;
              const qtySpan = document.getElementById(`qty-${id}`);
              let currentQty = parseInt(qtySpan.textContent);
              if (currentQty > 1) {
                const resp = await document.updateCartItemQuantity(
                  id,
                  currentQty - 1
                );
                console.log("Decrease resp:", resp);
                location.reload();
              }
            });
          });
        }

        if (token) {
          const cartData = await document.getCart();
          if (cartData && cartData.data && cartData.data.cartItems) {
            renderCartItems(cartData.data.cartItems, cartData.user);
          } else {
            renderCartItems([], cartData ? cartData.user : undefined);
          }
        } else {
          renderCartItems([]);
        }
      });
    </script>
    <script>
      // User state display in navbar with username dropdown and avatar (Bootstrap default)
      document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        const navEnd = document.querySelector(".text-end");
        if (navEnd) {
          if (token) {
            let username = "User";
            let avatarUrl = "Assets/BlankPFP.png";
            try {
              const payload = JSON.parse(atob(token.split(".")[1]));
              if (payload.name) username = payload.name;
              if (payload.photo) avatarUrl = payload.photo;
            } catch (e) {
              try {
                const res = await fetch(
                  "http://localhost:3000/api/v1/users/me",
                  {
                    headers: { Authorization: `Bearer ${token}` },
                  }
                );
                if (res.ok) {
                  const data = await res.json();
                  username = data.data.name || username;
                  avatarUrl = data.data.photo ? data.data.photo : avatarUrl;
                }
              } catch {}
            }
            navEnd.innerHTML = `
              <div class="dropdown d-flex align-items-center">
                <img src="Assets/BlankPFP.png" alt="avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;">
                <button class="btn btn-link dropdown-toggle p-0" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight:500;text-decoration:none;color:inherit;">
                  ${username}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                  <li><a class="dropdown-item" href="profile.html">Profile</a></li>
                  <li><a class="dropdown-item" href="orders.html">Orders</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                </ul>
              </div>
            `;
            document.getElementById("logoutBtn").onclick = function () {
              localStorage.removeItem("token");
              location.reload();
            };
          } else {
            navEnd.innerHTML = `
              <a href="signinPage.html"><button type="button" class="btn btn-light text-dark me-2 ms-4">Login</button></a>
              <a href="signupPage.html"><button type="button" class="btn btn-primary">Sign Up</button></a>
            `;
          }
        }
      });
    </script>
  </body>
</html>
