<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="styling.css" />
    <link rel="icon" type="image/x-icon" href="Assets/Box-seam.png" />
    <title>Search Results - PickPay</title>
  </head>
  <body class="d-flex flex-column min-vh-100">
    <!-- navbar -->
    <header class="py-3 mb-0 border-bottom">
      <div
        class="container d-flex flex-row align-items-center justify-content-between gap-3 flex-wrap"
      >
        <a
          href="/"
          class="d-flex align-items-center mb-0 me-2 link-body-emphasis text-decoration-none titleanimation"
        >
          <img src="logoo/logo1.png" alt="logo" width="50px" height="40px" />
          <span class="fs-4 me-1 title">PickPay</span>
        </a>
        <form
          class="d-flex searchmarg position-relative flex-grow-1 mx-2"
          role="search"
          style="max-width: 600px"
        >
          <input
            class="form-control me-2 navsearch"
            type="search"
            placeholder="What are you looking for?"
            aria-label="Search"
            autocomplete="off"
          />
          <div
            id="searchDropdown"
            class="dropdown-menu w-100"
            style="
              max-height: 300px;
              overflow-y: auto;
              position: absolute;
              top: 100%;
              left: 0;
              z-index: 1000;
              display: none;
              background-color: var(--dropdown-bg, #fff);
              color: var(--input-text, #212529);
            "
          ></div>
        </form>
        <div class="cart text-decoration-none me-2">
          <a
            href="cart.html"
            class="d-flex align-items-center link-body-emphasis text-decoration-none cartanim"
          >
            <img
              src="Assets/cart.svg"
              width="23"
              height="23"
              fill="currentColor"
              class="bi bi-box-seam me-1"
              viewBox="0 0 16 16"
            />
            <span class="cartext">Cart</span>
          </a>
        </div>
        <div class="dark-mode-toggle d-flex align-items-center mx-2">
          <button
            id="darkModeToggle"
            class="btn btn-sm theme-toggle-btn"
            aria-label="Toggle dark mode"
          >
            <i class="fa-solid fa-moon"></i>
          </button>
        </div>
        <div class="text-end d-flex align-items-center ms-2">
          <a href="signinPage.html"
            ><button type="button" class="btn btn-light text-dark me-2 ms-2">
              Login
            </button></a
          >
          <a href="signupPage.html"
            ><button type="button" class="btn btn-primary">Sign Up</button></a
          >
        </div>
      </div>
    </header>

    <!-- Search Results Content -->
    <div class="container my-5 flex-grow-1">
      <!-- Search Query Display -->
      <div id="searchQueryDisplay" class="mb-4">
        <h2>Search Results</h2>
        <div id="queryAnalysis" class="alert alert-info" style="display: none">
          <i class="fa-solid fa-brain me-2"></i>
          <strong>AI Understanding:</strong>
          <span id="analysisText"></span>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Searching for products...</p>
      </div>

      <!-- Search Results -->
      <div id="searchResults" style="display: none">
        <div class="row" id="resultsGrid"></div>

        <!-- Pagination -->
        <nav aria-label="Search results pagination" class="mt-4">
          <ul
            class="pagination justify-content-center"
            id="paginationContainer"
          ></ul>
        </nav>
      </div>

      <!-- No Results Found -->
      <div id="noResults" style="display: none">
        <div class="text-center py-5">
          <i class="fa-solid fa-search fa-3x text-muted mb-3"></i>
          <h3>No products found</h3>
          <p class="text-muted" id="noResultsMessage">
            We couldn't find any products matching your search.
          </p>

          <!-- Search Tips -->
          <div
            class="alert alert-light mt-4"
            style="max-width: 600px; margin: 0 auto"
          >
            <h6><i class="fa-solid fa-lightbulb me-2"></i>Search Tips:</h6>
            <ul class="list-unstyled mb-0 text-start">
              <li class="mb-2">
                <strong>"laptop under 30k"</strong> - Find laptops under 30,000
                EGP
              </li>
              <li class="mb-2">
                <strong>"Samsung TV 55 inch"</strong> - Find Samsung TVs with
                55" screen
              </li>
              <li class="mb-2">
                <strong>"iPhone 16GB storage"</strong> - Find iPhones with 16GB
                storage
              </li>
              <li class="mb-2">
                <strong>"black Nike shoes"</strong> - Find black Nike shoes
              </li>
              <li>
                <strong>"sofa between 5k and 15k"</strong> - Find sofas priced
                between 5,000-15,000 EGP
              </li>
            </ul>
          </div>
        </div>

        <!-- You Might Also Like Section -->
        <div id="youMightLike" class="mt-5">
          <h4 class="text-center mb-4">
            <i class="fa-solid fa-heart me-2 text-danger"></i>
            You Might Also Like
          </h4>
          <div class="row" id="recommendedProducts"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-body-tertiary text-center py-4 mt-auto">
      <p class="mb-0">© 2025 PickPay, Inc. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="script.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get("q");

        if (!query) {
          window.location.href = "index.html";
          return;
        }

        await performSearch(query);
      });

      // Enhanced query analysis function
      function analyzeQuery(query) {
        let processed = query.toLowerCase().trim();

        const queryAnalysis = {
          baseQuery: processed,
          priceConstraints: null,
          specifications: [],
          filters: {},
          intent: "search",
        };

        // Advanced price extraction patterns
        const pricePatterns = [
          {
            pattern:
              /(?:under|below|less\s+than|cheaper\s+than|maximum|max)\s*(\d+)(?:k|,?\d{3})?/gi,
            type: "max",
          },
          {
            pattern:
              /(?:over|above|more\s+than|expensive\s+than|minimum|min)\s*(\d+)(?:k|,?\d{3})?/gi,
            type: "min",
          },
          {
            pattern:
              /(?:between|from)\s*(\d+)(?:k|,?\d{3})?\s*(?:to|and|-)\s*(\d+)(?:k|,?\d{3})?/gi,
            type: "range",
          },
          {
            pattern: /(?:around|about|approximately)\s*(\d+)(?:k|,?\d{3})?/gi,
            type: "around",
          },
        ];

        // Extract price constraints
        pricePatterns.forEach(({ pattern, type }) => {
          const matches = [...processed.matchAll(pattern)];
          matches.forEach((match) => {
            let price1 = parseFloat(match[1]);
            let price2 = match[2] ? parseFloat(match[2]) : null;

            // Handle 'k' notation (20k = 20000)
            if (match[0].includes("k")) {
              price1 *= 1000;
              if (price2) price2 *= 1000;
            }

            switch (type) {
              case "max":
                queryAnalysis.priceConstraints = { max: price1 };
                break;
              case "min":
                queryAnalysis.priceConstraints = { min: price1 };
                break;
              case "range":
                queryAnalysis.priceConstraints = {
                  min: Math.min(price1, price2),
                  max: Math.max(price1, price2),
                };
                break;
              case "around":
                const margin = price1 * 0.1;
                queryAnalysis.priceConstraints = {
                  min: price1 - margin,
                  max: price1 + margin,
                };
                break;
            }

            processed = processed.replace(match[0], "").trim();
          });
        });

        // Extract brand filters
        const brandPattern =
          /(apple|samsung|xiaomi|sony|lg|hp|dell|lenovo|asus|nike|adidas|loreal|maybelline|black\s*&\s*decker|panasonic)/gi;
        const brandMatches = [...processed.matchAll(brandPattern)];
        if (brandMatches.length > 0) {
          queryAnalysis.filters.brand = brandMatches.map((m) =>
            m[0].toLowerCase()
          );
          brandMatches.forEach((match) => {
            processed = processed.replace(match[0], "").trim();
          });
        }

        // Extract specifications
        const specPatterns = {
          storage: { pattern: /(\d+)\s*(gb|tb)/gi },
          ram: { pattern: /(\d+)\s*(?:gb\s+)?(?:ram|memory)/gi },
          screenSize: { pattern: /(\d+(?:\.\d+)?)\s*(?:inch|"|inches)/gi },
        };

        Object.entries(specPatterns).forEach(([specType, config]) => {
          const matches = [...processed.matchAll(config.pattern)];
          if (matches.length > 0) {
            queryAnalysis.specifications.push({
              type: specType,
              values: matches.map((m) => ({
                value: parseFloat(m[1]),
                unit: m[2] || "gb",
              })),
            });
            matches.forEach((match) => {
              processed = processed.replace(match[0], "").trim();
            });
          }
        });

        queryAnalysis.baseQuery = processed.replace(/\s+/g, " ").trim();
        return queryAnalysis;
      }

      // Display query analysis
      function displayQueryAnalysis(queryAnalysis, originalQuery) {
        const analysisDiv = document.getElementById("queryAnalysis");
        const analysisText = document.getElementById("analysisText");

        let analysisParts = [];

        if (
          queryAnalysis.baseQuery &&
          queryAnalysis.baseQuery !== originalQuery.toLowerCase()
        ) {
          analysisParts.push(`Searching for: "${queryAnalysis.baseQuery}"`);
        }

        if (queryAnalysis.priceConstraints) {
          const { min, max } = queryAnalysis.priceConstraints;
          if (min && max) {
            analysisParts.push(
              `Price: EGP ${min.toFixed(0)} - ${max.toFixed(0)}`
            );
          } else if (max) {
            analysisParts.push(`Price: Under EGP ${max.toFixed(0)}`);
          } else if (min) {
            analysisParts.push(`Price: Over EGP ${min.toFixed(0)}`);
          }
        }

        if (queryAnalysis.filters.brand) {
          analysisParts.push(
            `Brand: ${queryAnalysis.filters.brand.join(", ")}`
          );
        }

        if (queryAnalysis.specifications.length > 0) {
          queryAnalysis.specifications.forEach((spec) => {
            if (spec.type === "storage") {
              analysisParts.push(
                `Storage: ${spec.values
                  .map((v) => `${v.value}${v.unit}`)
                  .join(", ")}`
              );
            } else if (spec.type === "ram") {
              analysisParts.push(
                `RAM: ${spec.values.map((v) => `${v.value}GB`).join(", ")}`
              );
            } else if (spec.type === "screenSize") {
              analysisParts.push(
                `Screen: ${spec.values.map((v) => `${v.value}"`).join(", ")}`
              );
            }
          });
        }

        if (analysisParts.length > 0) {
          analysisText.textContent = analysisParts.join(" | ");
          analysisDiv.style.display = "block";
        }
      }

      // Perform search with AI analysis
      async function performSearch(query) {
        const loadingState = document.getElementById("loadingState");
        const searchResults = document.getElementById("searchResults");
        const noResults = document.getElementById("noResults");
        const searchQueryDisplay =
          document.getElementById("searchQueryDisplay");

        // Update search query display
        searchQueryDisplay.querySelector(
          "h2"
        ).textContent = `Search Results for "${query}"`;

        // Analyze the query
        const queryAnalysis = analyzeQuery(query);
        displayQueryAnalysis(queryAnalysis, query);

        try {
          loadingState.style.display = "block";
          searchResults.style.display = "none";
          noResults.style.display = "none";

          // Build search URL with filters
          let searchUrl = `http://localhost:3000/api/v1/products?keyword=${encodeURIComponent(
            queryAnalysis.baseQuery || query
          )}&limit=20`;

          if (queryAnalysis.priceConstraints) {
            if (queryAnalysis.priceConstraints.min) {
              searchUrl += `&price[gte]=${queryAnalysis.priceConstraints.min}`;
            }
            if (queryAnalysis.priceConstraints.max) {
              searchUrl += `&price[lte]=${queryAnalysis.priceConstraints.max}`;
            }
          }

          if (
            queryAnalysis.filters.brand &&
            queryAnalysis.filters.brand.length > 0
          ) {
            searchUrl += `&brand=${encodeURIComponent(
              queryAnalysis.filters.brand[0]
            )}`;
          }

          // Try AI search first
          let result = null;
          try {
            const aiResponse = await fetch(
              "http://localhost:3000/api/v1/products/search-ai",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  query: queryAnalysis.baseQuery || query,
                  priceConstraints: queryAnalysis.priceConstraints,
                  specifications: queryAnalysis.specifications,
                  filters: queryAnalysis.filters,
                  fallbackSearch: true,
                }),
              }
            );

            if (aiResponse.ok) {
              result = await aiResponse.json();
            }
          } catch (aiError) {
            console.log("AI search failed, trying fallback");
          }

          // Fallback to regular search if AI fails
          if (!result || !result.products || result.products.length === 0) {
            const response = await fetch(searchUrl);
            if (response.ok) {
              const data = await response.json();
              result = {
                products: Array.isArray(data.data)
                  ? data.data
                  : Array.isArray(data.products)
                  ? data.products
                  : [],
              };
            }
          }

          loadingState.style.display = "none";

          if (result && result.products && result.products.length > 0) {
            // Apply client-side filtering
            let filteredProducts = applyClientSideFiltering(
              result.products,
              queryAnalysis
            );
            displaySearchResults(filteredProducts);
          } else {
            await displayNoResults(query, queryAnalysis);
          }
        } catch (error) {
          console.error("Search error:", error);
          loadingState.style.display = "none";
          await displayNoResults(query, queryAnalysis);
        }
      }

      // Apply client-side filtering
      function applyClientSideFiltering(products, queryAnalysis) {
        let filtered = [...products];

        // Price filtering
        if (queryAnalysis.priceConstraints) {
          filtered = filtered.filter((product) => {
            const price = product.price || 0;
            if (
              queryAnalysis.priceConstraints.min &&
              price < queryAnalysis.priceConstraints.min
            )
              return false;
            if (
              queryAnalysis.priceConstraints.max &&
              price > queryAnalysis.priceConstraints.max
            )
              return false;
            return true;
          });
        }

        // Brand filtering
        if (queryAnalysis.filters.brand) {
          filtered = filtered.filter((product) => {
            const title = product.title.toLowerCase();
            const brand = product.brand ? product.brand.toLowerCase() : "";
            return queryAnalysis.filters.brand.some(
              (b) => title.includes(b) || brand.includes(b)
            );
          });
        }

        return filtered;
      }

      // Display search results
      function displaySearchResults(products) {
        const searchResults = document.getElementById("searchResults");
        const resultsGrid = document.getElementById("resultsGrid");

        resultsGrid.innerHTML = products
          .map((product) => createProductCard(product))
          .join("");
        searchResults.style.display = "block";
      }

      // Create product card HTML with enhanced UI and proper images
      function createProductCard(product) {
        const productUrl = getProductURL(product);
        const imageUrl = getProductImage(product);

        return `
          <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
            <div class="card h-100 product-card shadow-sm border-0 overflow-hidden recommendation-card">
              <div class="position-relative overflow-hidden" style="height: 240px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <img src="${imageUrl}" 
                     alt="${product.title}" 
                     class="card-img-top"
                     style="height: 100%; width: 100%; object-fit: contain; padding: 20px; transition: transform 0.3s ease;"
                     onmouseover="this.style.transform='scale(1.05)'"
                     onmouseout="this.style.transform='scale(1)'"
                     onerror="this.src='Assets/placeholder.png'">
                ${
                  product.category
                    ? `<span class="badge bg-primary position-absolute top-0 end-0 m-3 px-3 py-2" style="border-radius: 15px; font-size: 0.75rem;">${product.category.name}</span>`
                    : ""
                }
                <div class="position-absolute bottom-0 start-0 end-0" style="background: linear-gradient(transparent, rgba(0,0,0,0.05)); height: 40px;"></div>
              </div>
              <div class="card-body p-4 d-flex flex-column">
                <h6 class="card-title mb-3 fw-semibold" title="${
                  product.title
                }" style="font-size: 0.95rem; line-height: 1.4; min-height: 2.8rem; overflow: hidden; color: #2c3e50;">
                  ${
                    product.title.length > 65
                      ? product.title.substring(0, 65) + "..."
                      : product.title
                  }
                </h6>
                <div class="mt-auto">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <span class="fw-bold text-success fs-4" style="color: #27ae60 !important;">EGP ${
                      product.price?.toFixed(2) || "N/A"
                    }</span>
                  </div>
                  <div class="d-flex align-items-center mb-3">
                    <div class="text-warning me-2" style="font-size: 1.1rem;">
                      ${"★".repeat(4)}${"☆".repeat(1)}
                    </div>
                    <span class="text-muted small">(${
                      Math.floor(Math.random() * 80) + 15
                    } reviews)</span>
                  </div>
                  <a href="${productUrl}" class="btn btn-primary w-100 fw-semibold py-2" style="border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; transition: all 0.3s ease;">
                    <i class="fa-solid fa-eye me-2"></i>View Details
                  </a>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Get proper product image with category-based fallbacks and smart product mapping
      function getProductImage(product) {
        // If product has a proper image cover, use it
        if (
          product.imageCover &&
          product.imageCover !== "Assets/placeholder.png" &&
          !product.imageCover.includes("placeholder")
        ) {
          return product.imageCover;
        }

        // Generate smart fallback image based on product ID, category, and title
        const title = product.title.toLowerCase();
        const category = product.category?.name?.toLowerCase() || "";
        const productId = product._id || "";

        // Map specific product IDs to their actual images from the main site
        const productImageMap = {
          // Electronics products - exact matches from index.html
          "6819e22b123a4faad16613be":
            "Assets/elec Cat/Mobile&Tablet/mobile&tablet 1.png", // Samsung Galaxy Tab
          "6819e22b123a4faad16613c0":
            "Assets/elec Cat/Mobile&Tablet/mobile&tablet 3.png", // iPhone 16
          "6819e22b123a4faad16613c3":
            "Assets/elec Cat/Mobile&Tablet/mobile&tablet 5.png", // Oraimo Charger
          "6819e22b123a4faad16613c4": "Assets/elec Cat/Tvs/TV 1.png", // Samsung QLED TV
          "6819e22b123a4faad16613c5": "Assets/elec Cat/Tvs/TV 2.png", // Xiaomi TV
          "6819e22b123a4faad16613c7": "Assets/elec Cat/Tvs/TV 4.png", // Sharp TV
          "6819e22b123a4faad16613ca": "Assets/elec Cat/Laptop/laptop 2.png", // Lenovo Legion
          "6819e22b123a4faad16613cb": "Assets/elec Cat/Laptop/laptop 3.png", // HP Victus

          // Appliances products
          "68252918a68b49cb06164212":
            "Assets/AppCat/Small Appliances/Small Appliances 8.png", // Dough Mixer
          "68252918a68b49cb06164211":
            "Assets/AppCat/Small Appliances/Small Appliances 7.png", // Kettle
          "68252918a68b49cb06164209":
            "Assets/AppCat/Small Appliances/Small Appliances 5.png", // Vacuum
          "68252918a68b49cb0616420a":
            "Assets/AppCat/Small Appliances/Small Appliances 2.png", // Coffee Maker
          "68252918a68b49cb06164208":
            "Assets/AppCat/Small Appliances/Small Appliances 1.png", // Air Fryer
          "68252918a68b49cb0616420b":
            "Assets/AppCat/Small Appliances/Small Appliances 3.png", // Toaster
          "68252918a68b49cb06164207":
            "Assets/AppCat/Large Appliances/Large Appliances 4.png", // Washing Machine
          "68252918a68b49cb0616420f":
            "Assets/AppCat/Large Appliances/Large Appliances 7.png", // Water Heater
          "68252918a68b49cb0616420e":
            "Assets/AppCat/Large Appliances/Large Appliances 6.png", // Wall Fan

          // Home products
          "681dab0df9c9147444b452cd":
            "Assets/HomeCat/Furniture/Furniture 1.png", // Sofa Bed
          "681dab0df9c9147444b452d0":
            "Assets/HomeCat/Furniture/Furniture 4.png", // Gaming Chair
          "681dab0df9c9147444b452d2":
            "Assets/HomeCat/Home Decor/Home Decor 1.png", // LED Lampshade
          "681dab0df9c9147444b452d5":
            "Assets/HomeCat/Home Decor/Home Decor 4.png", // Wall Clock
          "681dab0df9c9147444b452d8":
            "Assets/HomeCat/Kitchen&Dining/Kitchen 2.png", // Mug Set
          "681dab0df9c9147444b452db":
            "Assets/HomeCat/Kitchen&Dining/Kitchen 5.png", // Dish Rack
          "681dab0df9c9147444b452dc": "Assets/HomeCat/Bath&Bedding/Bath 1.png", // Cotton Towel
          "681dab0df9c9147444b452de": "Assets/HomeCat/Bath&Bedding/Bath 3.png", // Cotton Blanket
          "681dab0df9c9147444b452e0": "Assets/HomeCat/Bath&Bedding/Bath 5.png", // Duvet Cover

          // Video Games products
          "682b00a46977bd89257c0e80": "Assets/VidCat/Consoles/Console1.png", // PS5 Digital
          "682b00a46977bd89257c0e82": "Assets/VidCat/Consoles/Console3.png", // PS5 Nordic
          "682b00a46977bd89257c0e84":
            "Assets/VidCat/Controllers/Controller1.jpg.png", // DualSense Controller
          "682b00a46977bd89257c0e85":
            "Assets/VidCat/Controllers/Controller2.jpg.png", // DualSense White
          "682b00a46977bd89257c0e87":
            "Assets/VidCat/Controllers/Controller4.jpg.png", // DualSense Edge
          "682b00a46977bd89257c0e89":
            "Assets/VidCat/Accessories/Accessories1.png", // Quick Charger
          "682b00a46977bd89257c0e8a":
            "Assets/VidCat/Accessories/Accessories2.png", // Charging Station
          "682b00a46977bd89257c0e8c":
            "Assets/VidCat/Accessories/Accessories4.png", // Cooling Station

          // Fashion products
          "682b00c26977bd89257c0e9c":
            "Assets/FashionCat/Kids' Fashion/Kids' Fashion 5.png", // Ballerina Shoes
          "682b00c26977bd89257c0e9b":
            "Assets/FashionCat/Kids' Fashion/Kids' Fashion 4.png", // Baby Jacket
          "682b00c26977bd89257c0e9a":
            "Assets/FashionCat/Kids' Fashion/Kids' Fashion 3.png", // Denim Jacket
          "682b00c26977bd89257c0e97":
            "Assets/FashionCat/Men's Fashion/Men's Fashion 5.png", // Leather Wallet
          "682b00c26977bd89257c0e96":
            "Assets/FashionCat/Men's Fashion/Men's Fashion 4.png", // Timberland Boots
          "682b00c26977bd89257c0e92":
            "Assets/FashionCat/Women's Fashion/Women's fashion 5.png", // Aldo Handbag
          "682b00c26977bd89257c0e91":
            "Assets/FashionCat/Women's Fashion/Women's fashion 4.png", // Dejavu Sandal
          "682b00c26977bd89257c0e90":
            "Assets/FashionCat/Women's Fashion/Women's fashion 3.png", // American Eagle Jeans

          // Beauty products
          "682b00d16977bd89257c0e9d": "Assets/Beautycat/Makeup/Makeup 1.png", // L\'Oreal Mascara
          "682b00d16977bd89257c0e9e": "Assets/Beautycat/Makeup/Makeup 2.png", // L\'Oreal Foundation
          "682b00d16977bd89257c0ea1": "Assets/Beautycat/Makeup/Makeup 5.png", // Maybelline Lip Gloss
          "682b00d16977bd89257c0ea3":
            "Assets/Beautycat/Skincare/Skincare 2.png", // La Roche-Posay
          "682b00d16977bd89257c0ea4":
            "Assets/Beautycat/Skincare/Skincare 3.png", // Eva Toner
          "682b00d16977bd89257c0ea6":
            "Assets/Beautycat/Skincare/Skincare 5.png", // L\'Oreal Eye Serum
          "682b00d16977bd89257c0ea9":
            "Assets/Beautycat/Haircare/Haircare 3.png", // Garnier Hair Color
          "682b00d16977bd89257c0ead":
            "Assets/Beautycat/Fragrance/Fragrance 2.png", // Memwa Perfume
        };

        // Check if we have a specific image for this product
        if (productImageMap[productId]) {
          return productImageMap[productId];
        }

        // Category-based fallback images with actual paths from the main site
        if (
          category.includes("electronics") ||
          title.includes("phone") ||
          title.includes("iphone") ||
          title.includes("samsung") ||
          title.includes("mobile")
        ) {
          return "Assets/elec Cat/Mobile&Tablet/mobile&tablet 1.png";
        } else if (title.includes("laptop") || title.includes("computer")) {
          return "Assets/elec Cat/Laptop/laptop 1.png";
        } else if (title.includes("tv") || title.includes("television")) {
          return "Assets/elec Cat/Tvs/TV 1.png";
        } else if (
          category.includes("appliances") ||
          title.includes("washing") ||
          title.includes("refrigerator") ||
          title.includes("microwave")
        ) {
          return "Assets/AppCat/Large Appliances/Large Appliances 1.png";
        } else if (
          title.includes("air fryer") ||
          title.includes("toaster") ||
          title.includes("coffee")
        ) {
          return "Assets/AppCat/Small Appliances/Small Appliances 1.png";
        } else if (
          category.includes("home") ||
          title.includes("sofa") ||
          title.includes("chair") ||
          title.includes("furniture")
        ) {
          return "Assets/HomeCat/Furniture/Furniture 1.png";
        } else if (
          title.includes("lamp") ||
          title.includes("light") ||
          title.includes("decor")
        ) {
          return "Assets/HomeCat/Home Decor/Home Decor 1.png";
        } else if (
          title.includes("towel") ||
          title.includes("bedding") ||
          title.includes("pillow")
        ) {
          return "Assets/HomeCat/Bath&Bedding/Bath 1.png";
        } else if (
          title.includes("kitchen") ||
          title.includes("dining") ||
          title.includes("plate") ||
          title.includes("cup")
        ) {
          return "Assets/HomeCat/Kitchen&Dining/Kitchen 1.png";
        } else if (
          category.includes("fashion") ||
          title.includes("shoe") ||
          title.includes("clothing") ||
          title.includes("jean") ||
          title.includes("shirt")
        ) {
          return "Assets/FashionCat/Women's Fashion/Women's fashion 1.png";
        } else if (title.includes("men") || title.includes("male")) {
          return "Assets/FashionCat/Men's Fashion/Men's Fashion 1.png";
        } else if (
          title.includes("kid") ||
          title.includes("child") ||
          title.includes("baby")
        ) {
          return "Assets/FashionCat/Kids' Fashion/Kids' Fashion 1.png";
        } else if (
          category.includes("beauty") ||
          title.includes("makeup") ||
          title.includes("cosmetic") ||
          title.includes("mascara") ||
          title.includes("lipstick")
        ) {
          return "Assets/Beautycat/Makeup/Makeup 1.png";
        } else if (
          title.includes("skincare") ||
          title.includes("cream") ||
          title.includes("serum") ||
          title.includes("moisturizer")
        ) {
          return "Assets/Beautycat/Skincare/Skincare 1.png";
        } else if (
          title.includes("perfume") ||
          title.includes("fragrance") ||
          title.includes("cologne")
        ) {
          return "Assets/Beautycat/Fragrance/Fragrance 1.png";
        } else if (
          title.includes("hair") ||
          title.includes("shampoo") ||
          title.includes("conditioner")
        ) {
          return "Assets/Beautycat/Haircare/Haircare 1.png";
        } else if (
          category.includes("videogames") ||
          category.includes("gaming") ||
          title.includes("playstation") ||
          title.includes("xbox") ||
          title.includes("console")
        ) {
          return "Assets/VidCat/Consoles/Console1.png";
        } else if (title.includes("controller") || title.includes("gamepad")) {
          return "Assets/VidCat/Controllers/Controller1.jpg.png";
        } else if (
          title.includes("gaming") &&
          (title.includes("accessory") ||
            title.includes("charger") ||
            title.includes("stand"))
        ) {
          return "Assets/VidCat/Accessories/Accessories1.png";
        }

        return "Assets/placeholder.png";
      }

      // Get product URL
      function getProductURL(product) {
        const categoryMap = {
          electronics: "Electronics products",
          appliances: "AppliancesProducts",
          home: "home products",
          fashion: "fashion products",
          beauty: "beauty products",
          videogames: "videogames products",
        };

        let category = "AppliancesProducts";
        if (product.category && product.category.name) {
          const categoryName = product.category.name.toLowerCase();
          for (const [key, value] of Object.entries(categoryMap)) {
            if (categoryName.includes(key)) {
              category = value;
              break;
            }
          }
        }

        const productId = product._id ? product._id.toString().slice(-2) : "1";
        const numericId = parseInt(productId) || 1;
        return `ProductPages/${category}/product${numericId}.html`;
      }

      // Display no results with recommendations
      async function displayNoResults(query, queryAnalysis) {
        const noResults = document.getElementById("noResults");
        const noResultsMessage = document.getElementById("noResultsMessage");
        const recommendedProducts = document.getElementById(
          "recommendedProducts"
        );

        // Update no results message
        if (queryAnalysis.priceConstraints) {
          const { min, max } = queryAnalysis.priceConstraints;
          if (min && max) {
            noResultsMessage.textContent = `No products found for "${query}" in the price range EGP ${min.toFixed(
              0
            )} - ${max.toFixed(0)}.`;
          } else if (max) {
            noResultsMessage.textContent = `No products found for "${query}" under EGP ${max.toFixed(
              0
            )}.`;
          } else if (min) {
            noResultsMessage.textContent = `No products found for "${query}" over EGP ${min.toFixed(
              0
            )}.`;
          }
        } else {
          noResultsMessage.textContent = `We couldn't find any products matching "${query}".`;
        }

        // Load recommended products
        try {
          const response = await fetch(
            "http://localhost:3000/api/v1/products?limit=8&sort=-ratingsAverage"
          );
          if (response.ok) {
            const data = await response.json();
            const products = Array.isArray(data.data) ? data.data : [];

            if (products.length > 0) {
              recommendedProducts.innerHTML = products
                .map((product) => createProductCard(product))
                .join("");
            }
          }
        } catch (error) {
          console.error("Error loading recommendations:", error);
          recommendedProducts.innerHTML =
            '<p class="text-center text-muted">Unable to load recommendations</p>';
        }

        noResults.style.display = "block";
      }

      // Handle user authentication display
      document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        const navEnd = document.querySelector(".text-end");

        if (token) {
          let username = "User";
          let avatarUrl = "Assets/BlankPFP.png";

          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            if (payload.name) username = payload.name;
            if (payload.photo) avatarUrl = payload.photo;
          } catch (e) {
            try {
              const res = await fetch("http://localhost:5000/api/v1/users/me", {
                headers: { Authorization: `Bearer ${token}` },
              });
              if (res.ok) {
                const data = await res.json();
                username = data.data.name || username;
                avatarUrl = data.data.photo ? data.data.photo : avatarUrl;
              }
            } catch {}
          }

          navEnd.innerHTML = `
          <div class="dropdown d-flex align-items-center">
            <img src="${avatarUrl}" alt="avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;">
            <button class="btn btn-link dropdown-toggle p-0" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight:500;text-decoration:none;color:inherit;">
              ${username}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="profile.html">Profile</a></li>
              <li><a class="dropdown-item" href="orders.html">Orders</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
            </ul>
          </div>
        `;

          document.getElementById("logoutBtn").onclick = function () {
            localStorage.removeItem("token");
            location.reload();
          };
        }
      });
    </script>
  </body>
</html>
