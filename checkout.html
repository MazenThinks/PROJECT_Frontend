<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="styling.css" />
    <link rel="stylesheet" href="elecCat.css" />
    <title>Checkout</title>
  </head>
  <body>
    <header class="py-3 mb-0 border-bottom">
      <div
        class="container d-flex flex-row align-items-center justify-content-between gap-3 flex-wrap"
      >
        <a
          href="/"
          class="d-flex align-items-center mb-0 me-2 link-body-emphasis text-decoration-none titleanimation"
        >
          <img src="logoo/logo1.png" alt="logo" width="50px" height="40px" />
          <span class="fs-4 me-1 title">PickPay</span>
        </a>
        <form
          class="d-flex searchmarg position-relative flex-grow-1 mx-2"
          role="search"
          style="max-width: 600px"
        >
          <input
            class="form-control me-2 navsearch"
            type="search"
            placeholder="What are you looking for?"
            aria-label="Search"
            autocomplete="off"
          />
          <div
            id="searchDropdown"
            class="dropdown-menu w-100"
            style="
              max-height: 300px;
              overflow-y: auto;
              position: absolute;
              top: 100%;
              left: 0;
              z-index: 1000;
              display: none;
              background-color: var(--dropdown-bg, #fff);
              color: var(--input-text, #212529);
            "
          ></div>
        </form>
        <div class="cart text-decoration-none me-2">
          <a
            href="cart.html"
            class="d-flex align-items-center link-body-emphasis text-decoration-none cartanim"
          >
            <img
              src="Assets/cart.svg"
              width="23"
              height="23"
              fill="currentColor"
              class="bi bi-box-seam me-1"
              viewBox="0 0 16 16"
            />
            <span class="cartext">Cart</span>
          </a>
        </div>
        <div class="dark-mode-toggle d-flex align-items-center mx-2">
          <button
            id="darkModeToggle"
            class="btn btn-sm theme-toggle-btn"
            aria-label="Toggle dark mode"
          >
            <i class="fa-solid fa-moon"></i>
          </button>
        </div>
        <div class="text-end d-flex align-items-center ms-2">
          <a href="signinPage.html"
            ><button type="button" class="btn btn-light text-dark me-2 ms-2">
              Login
            </button></a
          >
          <a href="signupPage.html"
            ><button type="button" class="btn btn-primary">Sign Up</button></a
          >
        </div>
      </div>
    </header>
    <nav
      class="navbar navbar-expand-lg bg-body-tertiary second-navbar d-flex justify-content-center"
      style="
        background: none !important;
        background-color: var(--navbar-bg) !important;
      "
    >
      <div class="container-fluid d-flex flex-wrap justify-content-center">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse d-flex justify-content-center"
          id="navbarNav"
        >
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="index.html">All</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="elecCat.html">Electronics</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="ApplianCat.html">Appliances</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="HomeCat.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="videogamecat.html">Video Games</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="Fashion.html">Fashion</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="Beauty.html">Beauty & Fragrance</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <main>
        <div class="py-5 text-center">
          <h2>Checkout</h2>
          <!-- <p class="lead">fill the following application</p> -->
        </div>

        <div class="row g-5">
          <div class="col-md-5 col-lg-4 order-md-last">
            <h4 class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-primary">Your cart</span>
              <span class="badge bg-primary rounded-pill" id="cartItemCount"
                >3</span
              >
            </h4>
            <ul class="list-group mb-3" id="cartItemsList">
              <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                  <h6 class="my-0">Sample Product 1</h6>
                  <small class="text-body-secondary">Electronics</small>
                </div>
                <span class="text-body-secondary">EGP 250</span>
              </li>
              <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                  <h6 class="my-0">Sample Product 2</h6>
                  <small class="text-body-secondary">Fashion</small>
                </div>
                <span class="text-body-secondary">EGP 180</span>
              </li>
              <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                  <h6 class="my-0">Sample Product 3</h6>
                  <small class="text-body-secondary">Home</small>
                </div>
                <span class="text-body-secondary">EGP 120</span>
              </li>
              <li
                class="list-group-item d-flex justify-content-between bg-body-tertiary"
              >
                <div class="text-success">
                  <h6 class="my-0">Promo code</h6>
                  <small>SAVE20</small>
                </div>
                <span class="text-success">-EGP 110</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Total (EGP)</span>
                <strong id="totalAmount">EGP 440</strong>
              </li>
            </ul>

            <form class="card p-2" id="promoForm">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Promo code"
                  id="promoInput"
                />
                <button type="submit" class="btn btn-secondary" id="redeemBtn">
                  Redeem
                </button>
              </div>
              <div id="couponMessage" class="mt-2" style="display: none"></div>
            </form>
          </div>

          <div class="col-md-7 col-lg-8">
            <h4 class="mb-3">Billing address</h4>
            <form class="needs-validation" novalidate id="checkoutForm">
              <div class="row g-3">
                <div class="col-sm-6">
                  <label for="firstName" class="form-label">First name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="firstName"
                    required
                  />
                  <div class="invalid-feedback">
                    Valid first name is required.
                  </div>
                </div>

                <div class="col-sm-6">
                  <label for="lastName" class="form-label">Last name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lastName"
                    required
                  />
                  <div class="invalid-feedback">
                    Valid last name is required.
                  </div>
                </div>

                <div class="col-12">
                  <label for="email" class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    placeholder="you@example.com"
                    required
                  />
                  <div class="invalid-feedback">
                    Please enter a valid email address.
                  </div>
                </div>

                <div class="col-12">
                  <label for="address" class="form-label">Address</label>
                  <input
                    type="text"
                    class="form-control"
                    id="address"
                    placeholder="1234 Main St"
                    required
                  />
                  <div class="invalid-feedback">
                    Please enter your shipping address.
                  </div>
                </div>

                <div class="col-12">
                  <label for="address2" class="form-label"
                    >Address 2
                    <span class="text-body-secondary">(Optional)</span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="address2"
                    placeholder="Apartment or suite"
                  />
                </div>

                <div class="col-md-5">
                  <label for="country" class="form-label">Country</label>
                  <select class="form-select" id="country" required>
                    <option value="">Choose...</option>
                    <option value="Egypt">Egypt</option>
                  </select>
                  <div class="invalid-feedback">
                    Please select a valid country.
                  </div>
                </div>

                <div class="col-md-4">
                  <label for="state" class="form-label">State</label>
                  <select class="form-select" id="state" required>
                    <option value="">Choose...</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Giza">Giza</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Menofia">Menofia</option>
                    <option value="Qalyubia">Qalyubia</option>
                  </select>
                  <div class="invalid-feedback">
                    Please provide a valid state.
                  </div>
                </div>

                <div class="col-md-3">
                  <label for="phone" class="form-label">Phone Number</label>
                  <input type="tel" class="form-control" id="phone" required />
                  <div class="invalid-feedback">Phone number required.</div>
                </div>
              </div>

              <hr class="my-4" />

              <h4 class="mb-3">Payment</h4>
              <div class="my-3">
                <div class="form-check">
                  <input
                    id="credit"
                    name="paymentMethod"
                    type="radio"
                    class="form-check-input"
                    value="stripe"
                    required
                  />
                  <label class="form-check-label" for="credit"
                    >Credit/Debit Card (Stripe)</label
                  >
                </div>
                <div class="form-check">
                  <input
                    id="cash"
                    name="paymentMethod"
                    type="radio"
                    class="form-check-input"
                    value="cash"
                    required
                  />
                  <label class="form-check-label" for="cash"
                    >Cash on Delivery</label
                  >
                </div>
              </div>

              <hr class="my-4" />
              <button
                class="w-100 btn btn-primary btn-lg"
                type="submit"
                id="placeOrderBtn"
              >
                Place Order
              </button>
            </form>
          </div>
        </div>
      </main>
    </div>

    <!-- Footer -->
    <div class="text-center bg-body-tertiary">
      <footer class="py-4">
        <div class="container">
          <div class="row">
            <div class="col-6 col-md-2 mb-3">
              <h5>Electronics</h5>
              <ul class="nav flex-column">
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Mobile & Tablets</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary">TVs</a>
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Laptops</a
                  >
                </li>
              </ul>
            </div>

            <div class="col-6 col-md-2 mb-3">
              <h5>Appliances</h5>
              <ul class="nav flex-column">
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Large Appliances</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Small Appliances</a
                  >
                </li>
              </ul>
            </div>

            <div class="col-6 col-md-2 mb-3">
              <h5>Home</h5>
              <ul class="nav flex-column">
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Furniture</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Home Decor</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Kitchen & Dining</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Bath & Bedding</a
                  >
                </li>
              </ul>
            </div>

            <div class="col-6 col-md-2 mb-3">
              <h5>Video Games</h5>
              <ul class="nav flex-column">
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Console</a
                  >
                </li>

                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Controllers</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Accessories</a
                  >
                </li>
              </ul>
            </div>

            <div class="col-6 col-md-2 mb-3">
              <h5>Fashion</h5>
              <ul class="nav flex-column">
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Women's Fashion</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Men's Fashion</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Kids' Fashion</a
                  >
                </li>
              </ul>
            </div>

            <div class="col-6 col-md-2 mb-3">
              <h5>Beauty & Fragrance</h5>
              <ul class="nav flex-column">
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Makeup</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Skincare</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Haircare</a
                  >
                </li>
                <li class="nav-item mb-2">
                  <a href="#" class="nav-link p-0 text-body-secondary"
                    >Fragrance</a
                  >
                </li>
              </ul>
            </div>
          </div>

          <div class="py-3 border-top">
            <p>© 2025 PickPay, Inc. All rights reserved.</p>
          </div>
        </div>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      const API_BASE = "http://localhost:3000/api/v1";

      // Load cart data on page load
      document.addEventListener("DOMContentLoaded", async function () {
        await loadCartData();
        setupPaymentHandling();
        setupPromoCode();
      });

      // Load cart data from backend
      async function loadCartData() {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            document.getElementById("cartItemsList").innerHTML =
              '<li class="list-group-item text-center">Please login to view cart</li>';
            return;
          }

          const response = await fetch(`${API_BASE}/cart`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const data = await response.json();
            displayCartItems(data.data);
          } else {
            console.error("Failed to load cart data");
          }
        } catch (error) {
          console.error("Error loading cart:", error);
        }
      }

      // Display cart items
      function displayCartItems(cart) {
        const cartList = document.getElementById("cartItemsList");
        const cartCount = document.getElementById("cartItemCount");

        if (!cart || !cart.cartItems || cart.cartItems.length === 0) {
          cartList.innerHTML =
            '<li class="list-group-item text-center">Your cart is empty</li>';
          cartCount.textContent = "0";
          return;
        }

        cartCount.textContent = cart.cartItems.length;

        let itemsHTML = "";
        cart.cartItems.forEach((item) => {
          itemsHTML += `
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">${item.product.title}</h6>
                <small class="text-body-secondary">Qty: ${item.quantity}</small>
              </div>
              <span class="text-body-secondary">EGP ${item.price}</span>
            </li>`;
        });

        // Add total
        itemsHTML += `
          <li class="list-group-item d-flex justify-content-between">
            <span>Total (EGP)</span>
            <strong>EGP ${cart.totalCartPrice}</strong>
          </li>`;

        cartList.innerHTML = itemsHTML;
        document.getElementById(
          "totalAmount"
        ).textContent = `EGP ${cart.totalCartPrice}`;
      }

      // Setup payment handling
      function setupPaymentHandling() {
        const form = document.getElementById("checkoutForm");
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const paymentMethod = document.querySelector(
            'input[name="paymentMethod"]:checked'
          );
          if (!paymentMethod) {
            alert("Please select a payment method");
            return;
          }

          if (paymentMethod.value === "stripe") {
            await handleStripePayment();
          } else {
            await handleCashOrder();
          }
        });
      }

      // Handle Stripe payment
      async function handleStripePayment() {
        try {
          const token = localStorage.getItem("token");
          const cartResponse = await fetch(`${API_BASE}/cart`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!cartResponse.ok) {
            alert("Error accessing cart");
            return;
          }

          const cartData = await cartResponse.json();
          const cartId = cartData.data._id;

          const checkoutResponse = await fetch(
            `${API_BASE}/orders/checkout-session/${cartId}`,
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (checkoutResponse.ok) {
            const sessionData = await checkoutResponse.json();
            const stripe = Stripe(
              "pk_test_51RRcTiDEyCHwA6a7WqC7ypXHyDk87xUoNpbs68TdhjjLffPN2fSaoKquzQY5desPmDodUWrxgprTlXYXy1H41bKw00BM6RT6wB"
            );
            stripe.redirectToCheckout({ sessionId: sessionData.session.id });
          } else {
            alert("Failed to create payment session");
          }
        } catch (error) {
          alert("Payment error: " + error.message);
        }
      }

      // Handle cash on delivery order
      async function handleCashOrder() {
        try {
          const token = localStorage.getItem("token");
          const cartResponse = await fetch(`${API_BASE}/cart`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const cartData = await cartResponse.json();
          const cartId = cartData.data._id;

          // Collect shipping address
          const shippingAddress = {
            details: document.getElementById("address").value,
            phone: document.getElementById("phone").value,
            city: document.getElementById("state").value,
            postalCode: document.getElementById("address2").value || "00000",
          };

          const orderResponse = await fetch(`${API_BASE}/orders/${cartId}`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ shippingAddress }),
          });

          if (orderResponse.ok) {
            alert("Order placed successfully! You will pay on delivery.");
            window.location.href = "index.html";
          } else {
            const error = await orderResponse.json();
            alert("Order failed: " + (error.message || "Unknown error"));
          }
        } catch (error) {
          alert("Order error: " + error.message);
        }
      }

      // Setup promo code functionality
      function setupPromoCode() {
        document
          .getElementById("promoForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const promoCode = document
              .getElementById("promoInput")
              .value.trim();
            const messageDiv = document.getElementById("couponMessage");

            if (!promoCode) {
              showMessage(messageDiv, "Please enter a promo code", "danger");
              return;
            }

            const token = localStorage.getItem("token");
            if (!token) {
              showMessage(messageDiv, "Please login to apply coupon", "danger");
              return;
            }

            try {
              const response = await fetch(`${API_BASE}/cart/applyCoupon`, {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ coupon: promoCode }),
              });

              const data = await response.json();

              if (response.ok) {
                showMessage(
                  messageDiv,
                  "Coupon applied successfully!",
                  "success"
                );
                await loadCartData(); // Reload cart to show updated prices
              } else {
                showMessage(
                  messageDiv,
                  data.message || "Invalid promo code",
                  "danger"
                );
              }
            } catch (error) {
              showMessage(messageDiv, "Error applying coupon", "danger");
            }
          });
      }

      // Show message helper
      function showMessage(element, message, type) {
        element.style.display = "block";
        element.className = `mt-2 text-${type}`;
        element.textContent = message;

        setTimeout(() => {
          element.style.display = "none";
        }, 5000);
      }
    </script>
  </body>
</html>
